<template>
  <require from="./valueconverters/formattime"></require>
  <require from="./valueconverters/formatpost"></require>
  <div class="chat" class.bind="`theme-${theme}`">
    <div ref="postContainer" class="chat-postcontainer">
      <ul>
        <li class="post" repeat.for="post of posts">
          <div class="post-header">
            <span class="time">${post.posted | formatTime }</span>
            <span class="name">${post.name}</span>
          </div>
          <div class="post-body">
            <div if.bind="post.image" class="post-image" class.bind="post.showFullImage ? 'expanded' : ''">
              <a href.bind="post.image.url" click.trigger="$parent.toggleImage(post)" target="_blank">
                <img class="thumbnail" src.bind="post.image.thumbUrl" title.bind="post.image.originalFilename">
                <img if.bind="post.showFullImage" class="expanded-image" src.bind="post.image.url">
              </a>
              <div class="filename">${post.image.originalFilename}</div>
            </div>
            <div class="comment" innerHTML.bind="post.comment | formatPost"></div>
          </div>
        </li>
      </ul>
      <!-- This is part of a workaround for a bug in Chrome causing it to not correctly recalculate the post container layout when the posting form is resized -->
      <div if.bind="triggerPostLayout" class="after-posts"></div>
    </div>

    <div ref="chatControls" class="chatcontrols">
      <form ref="postForm" submit.delegate="submitPost($event)">
        <div if.bind="!useCompactPostForm">
          <table class="chatcontrols-table">
            <tr>
              <td>Name</td>
              <td><input name="name" type="text" value.bind="post.name" placeholder="Anonymous" readonly.bind="posting"></td>
            </tr>
            <tr>
              <td>Comment</td>
              <td><textarea name="comment" value.bind="post.comment" maxlength="600" class="comment-field" wrap="soft" readonly.bind="posting" keypress.trigger="submitOnEnterKeypress($event)" autofocus></textarea></td>
            </tr>
            <tr>
              <td>Image</td>
              <td><input name="image" type="file" accept="image/*" change.delegate="imageSelected($event)" disabled.bind="posting" keypress.trigger="submitOnEnterKeypress($event)" click.trigger="clearFileOnShiftClick($event)"></td>
            </tr>
            <tr>
              <td></td>
              <td>
                <button id="postbutton" type="submit" disabled.bind="!canSubmitPost">${postingCooldownText || 'Post'}</button>
                <span class="progress">${postingProgress}</span>
              </td>
            </tr>
          </table>
          <div class="version-text">
            ${versionText}
          </div>
        </div>
        <div if.bind="useCompactPostForm" class="chatcontrols-table">
          <textarea name="comment" value.bind="post.comment" maxlength="600" class="comment-field" wrap="soft" readonly.bind="posting" keypress.trigger="submitOnEnterKeypress($event)" autofocus></textarea>
          <button id="postbutton" type="submit" disabled.bind="!canSubmitPost">${postingCooldownText || postingProgress || 'Post'}</button>
          <input name="image" type="file" accept="image/*" change.delegate="imageSelected($event)" disabled.bind="posting" keypress.trigger="submitOnEnterKeypress($event)" click.trigger="clearFileOnShiftClick($event)">
        </div>
      </form>
      <div class="options">
        <select if.bind="!useCompactPostForm" value.bind="theme" change.delegate="themeSelected()">
          <option repeat.for="theme of themes" value.bind="theme.name">${theme.description}</option>
        </select>
        <button type="button" click.trigger="toggleCompactPostForm()" title="Toggle compact post form"><span class="fa" class.bind="useCompactPostForm ? 'fa-caret-up' : 'fa-caret-down'"></span></button>
      </div>
    </div>
  </div>
</template>
